name: deploy
on:
  push:
    branches:
      - main
      - master
jobs: 
  build-and-deploy: 
    runs-on: ubuntu-latest
    steps: 
      - 
        name: "Checkout source code"
        uses: actions/checkout@v2
      - 
        name: "Cache dependencies"
        uses: actions/cache@v2
        with: 
          key: "${{ runner.os }}-gems-${{ hashFiles('**/Gemfile') }}"
          path: vendor/bundle
          restore-keys: "${{ runner.os }}-gems-\n"
      - 
        name: "Bundle site"
        uses: jerryjvl/jekyll-build-action@v1
      - 
        name: "Install SSH Key"
        uses: shimataro/ssh-key-action@v2
        with: 
          key: "${{ secrets.SSH_PRIVATE_KEY }}"
          known_hosts: just-a-placeholder-so-we-dont-get-errors
      - 
        name: "Adding Known Hosts"
        run: "ssh-keyscan -H -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_HOST }}  >> ~/.ssh/known_hosts"
      - 
        name: "Deploy with rsync"
        run: "rsync -avzc -e \"ssh -p ${{ secrets.SSH_PORT }}\" ./_site/ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/kvasnytskyi.net/"
